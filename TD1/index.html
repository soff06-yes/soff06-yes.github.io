<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Exercice Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil"></script>

  <script>
    const marseille = [43.2965, 5.3698];
    const nice = [43.7102, 7.2620];
    const map = L.map("map").setView([43.7, 7.25], 6);
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);
    const stamen = L.tileLayer("https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png", {
      attribution: "© Stamen"
    });
    L.control.layers({ "OSM": osm, "Stamen": stamen }).addTo(map);
    L.marker(nice).addTo(map).bindPopup("Nice - Centre ville");
    const bermudes = [
      [25.774, -80.19], 
      [18.466, -66.118], 
      [32.321, -64.757] 
    ];
    L.polygon(bermudes, {color: "red"}).addTo(map).bindPopup("Triangle des Bermudes");

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        const userPos = [lat, lon];
        map.setView(userPos, 10);
        L.marker(userPos).addTo(map).bindPopup("Vous êtes ici").openPopup();
        L.circle(userPos, {radius: accuracy, color:"red", fillOpacity:0.2}).addTo(map);
        L.polyline([marseille, nice], {color:"green"}).addTo(map).bindPopup("Segment Marseille ↔ Nice");
        L.polyline([marseille, userPos], {color:"purple"}).addTo(map);

        const R = 6371; 
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat - marseille[0]);
        const dLon = toRad(lon - marseille[1]);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(toRad(marseille[0])) * Math.cos(toRad(lat)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = (R * c).toFixed(2);

        L.marker(marseille).addTo(map).bindPopup(`Marseille<br>Distance de vous : ${distance} km`).openPopup();
      });
    }
    const geojsonExample = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "name": "Point test" },
          "geometry": { "type": "Point", "coordinates": [7.25, 43.7] }
        }
      ]
    };
    L.geoJSON(geojsonExample).addTo(map);
    fetch("https://router.project-osrm.org/route/v1/driving/7.2620,43.7102;5.3698,43.2965?overview=full&geometries=geojson")
      .then(res => res.json())
      .then(data => {
        const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
        L.polyline(coords, {color:"orange"}).addTo(map).bindPopup("Route Nice → Marseille (OSRM)");
      });
  </script>
</body>
</html>
